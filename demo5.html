<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Instruktionsfilmer</title>
  <link rel="icon" href="favicon.ico">
  <style>
    :root{
      --card-radius: 12px;
    }

    /* ---------- BAS ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: Arial, sans-serif;
      background:#f3f5f7;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:24px;
    }

    .container{
      background:#fff;
      padding:28px;
      border-radius:14px;
      box-shadow: 0 6px 24px rgba(12,20,30,0.06);
      max-width:980px;
      width:100%;
    }
    .logo{ max-width:220px; height:auto; display:block; margin:0 auto 8px; }
    h1{ text-align:center; margin:6px 0 18px; color:#222; font-size:1.6rem; }

    /* ---------- SÖK & KATEGORIER ---------- */
    .search-wrapper{ position:sticky; top:0; z-index:60; background:transparent; display:flex; justify-content:center; margin-bottom:8px; }
    #search{
      width:100%; max-width:520px;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #d7dfe6;
      background:#fff;
      font-size:16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .search-all-wrapper{ display:flex; justify-content:center; margin:8px 0 16px; }
    #search-all-btn{
      display:none;
      padding:10px 14px;
      border-radius:9px;
      border:none;
      background:#495057;
      color:#fff;
      cursor:pointer;
    }

    .categories{
      display:flex; gap:10px; justify-content:center;
      flex-wrap:wrap; margin-bottom:18px;
    }
    .categories a{
      display:inline-block;
      padding:8px 14px;
      border-radius:999px;
      background:#e9f0ff;
      color:#034ea2;
      font-weight:600;
      text-decoration:none;
      transition: all .15s;
      box-shadow: 0 1px 0 rgba(255,255,255,0.7) inset;
    }
    .categories a:hover{ transform:translateY(-2px); }
    .categories a.active{ background:#28a745; color:white; box-shadow:none; }

    #active-category-label{ text-align:center; margin:8px 0 12px; font-weight:700; display:none; }

    /* ---------- VIDEOLISTA (stackad, responsive) ---------- */
    .video{
      width:100%;
      margin: 0 0 24px 0;
    }
    .video h2{
      font-size:1.05rem;
      color:#222;
      margin:0 0 10px 0;
      padding:0 6px;
    }

    /* ---------- THUMBNAIL WRAPPER (fix: full width) ---------- */
    .video-thumb-wrapper{
      position:relative;
      width:100%;
      border-radius:var(--card-radius);
      overflow:hidden;
      display:block;           /* viktigt: tar full bredd */
      background:#000;
    }
    .video-thumb-wrapper img{
      width:100%;
      height:auto;
      display:block;
      object-fit:cover;
    }

    /* dark overlay on hover to indicate click */
    .video-thumb-wrapper::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.18));
      opacity:0;
      transition:opacity .18s ease;
      pointer-events:none;
    }
    .video-thumb-wrapper:hover::after{ opacity:1; }

    /* ---------- MODERN PLAY BUTTON (neumorphism-ish + centered SVG) ---------- */
    .play-btn{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:76px;
      height:76px;
      border-radius:50%;
      background: rgba(255,255,255,0.95); /* vit rund knapp */
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 8px 20px rgba(10,20,30,0.12), inset 0 1px 0 rgba(255,255,255,0.7);
      transition: transform .16s ease, box-shadow .16s ease;
      z-index:5;
      pointer-events:auto;
    }
    .video-thumb-wrapper:hover .play-btn{
      transform:translate(-50%,-50%) scale(1.06);
      box-shadow: 0 12px 26px rgba(10,20,30,0.16), inset 0 1px 0 rgba(255,255,255,0.8);
    }

    /* SVG triangle (centered, crisp, easily color-changable) */
    .play-btn svg{ width:28px; height:28px; display:block; }
    .play-btn .tri{ fill:#111; } /* triangeln – mörk färg för kontrast */

    /* ---------- Iframe styling när laddad ---------- */
    .video-thumb-wrapper iframe{
      width:100%;
      height:100%;
      display:block;
      border:none;
    }
    /* default ratio for iframe area; we replace innerHTML with iframe that uses aspect-ratio */
    .video-thumb-wrapper .placeholder{
      aspect-ratio:16/9;
      width:100%;
      display:block;
    }

    /* ---------- Övrigt ---------- */
    #no-results{ text-align:center; color:#666; display:none; margin:12px 0; }
    #suggestion-form{ margin-top:12px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    #suggestion-input{ width:100%; max-width:520px; padding:10px 12px; border-radius:8px; border:1px solid #d7dfe6; }
    #send-suggestion{ padding:10px 14px; border-radius:8px; border:none; background:#28a745; color:white; cursor:pointer; }

    /* responsive tweaks */
    @media (min-width:900px){
      .container{ padding:36px; }
      .video h2{ font-size:1.1rem; }
    }
    @media (max-width:520px){
      .play-btn{ width:60px; height:60px; }
      .play-btn svg{ width:22px; height:22px; }
    }

  </style>
</head>
<body>
  <div class="container">
    <p id="last-updated"></p>
    <img src="logga.png" alt="Företagslogga" class="logo">
    <h1>Instruktionsfilmer</h1>

    <div class="search-wrapper">
      <input id="search" type="text" placeholder="Sök efter film...">
    </div>
    <div class="search-all-wrapper">
      <button id="search-all-btn">Sök i alla</button>
    </div>

    <nav class="categories">
      <a href="#" class="active">Alla</a>
      <a href="#">Tekniker</a>
      <a href="#">Ekonomi</a>
      <a href="#">Admin</a>
    </nav>
    <div id="active-category-label"></div>

    <div id="video-container"></div>
    <p id="no-results">Inga filmer hittades.</p>

    <div id="suggestion-form">
      <input id="suggestion-input" placeholder="Skriv ditt förslag här">
      <button id="send-suggestion">Skicka förslag</button>
    </div>
  </div>

  <div id="toast" class="toast">Förslaget skickat!</div>

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
  emailjs.init("86Xo_kJFJ5nr-AGLL");

  let mockMode = false;
  const MAX_PER_DAY = 3;
  const search = document.getElementById('search');
  const searchAllBtn = document.getElementById('search-all-btn');
  const categoriesEl = document.querySelector('.categories');
  const activeLabel = document.getElementById('active-category-label');
  const noResults = document.getElementById('no-results');
  const videoContainer = document.getElementById('video-container');

  let videoData = [];
  let fuse;
  let undoTimeout;
  let pendingSend = false;
  let pendingData = null;

  document.getElementById("last-updated").textContent = "Senast uppdaterad: " + new Date(document.lastModified).toLocaleString();

  // ===== Ladda JSON och rendera thumbnails + play-knapp =====
  async function loadVideos(){
    try {
      const res = await fetch('filmer.json');
      const videos = await res.json();

      // skapa videokorten (stackade)
      videos.forEach(video=>{
        const div = document.createElement('div');
        div.className = 'video';
        div.dataset.category = video.category;

        const thumbnail = `https://img.youtube.com/vi/${video.youtubeId}/hqdefault.jpg`;

        div.innerHTML = `
          <h2>${escapeHtml(video.title)}</h2>
          <div class="video-thumb-wrapper" aria-role="button" tabindex="0">
            <img src="${thumbnail}" alt="${escapeHtml(video.title)}" class="placeholder">
            <div class="play-btn" aria-hidden="true">
              <!-- SVG triangeln är centrerad och konsekvent -->
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <path class="tri" d="M8 5v14l11-7z"/>
              </svg>
            </div>
          </div>
        `;

        // Klick / Enter / Space -> ladda iframe
        const wrapper = div.querySelector('.video-thumb-wrapper');
        const loadIframe = ()=>{
          wrapper.innerHTML = `<iframe src="https://www.youtube.com/embed/${video.youtubeId}?autoplay=1" allowfullscreen style="width:100%;aspect-ratio:16/9;border-radius:var(--card-radius);border:none;"></iframe>`;
        };
        wrapper.addEventListener('click', loadIframe);
        wrapper.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); loadIframe(); }
        });

        videoContainer.appendChild(div);
      });

      // initiera fuse
      videoData = Array.from(document.querySelectorAll('.video')).map(v=>({
        element: v,
        title: v.querySelector('h2').textContent,
        category: v.dataset.category
      }));

      fuse = new Fuse(videoData, { keys: ['title','category'], threshold:0.4, includeMatches:true });
      initCategoryClicks();
    } catch(err){
      console.error('Kunde inte ladda videor:', err);
      noResults.style.display = 'block';
      noResults.textContent = 'Kunde inte ladda filmer.';
    }
  }

  loadVideos();

  // ===== Escape helper (för titlar inuti HTML) =====
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
  }

  // ===== Highlight helper =====
  function highlightText(text, matches){
    let result = '', lastIndex = 0;
    matches.forEach(match=>{
      match.indices.forEach(([start,end])=>{
        result += text.slice(lastIndex,start);
        result += '<mark>' + text.slice(start,end+1) + '</mark>';
        lastIndex = end+1;
      });
    });
    result += text.slice(lastIndex);
    return result;
  }

  // ===== Toast functions =====
  function showToast(message, success=true, allowUndo=false){
    const toast = document.getElementById("toast");
    toast.innerHTML = message;
    toast.style.background = success===true ? "#28a745" : success===false ? "#dc3545" : "#007bff";
    if(allowUndo){
      const undoBtn = document.createElement("button");
      undoBtn.textContent = "Ångra";
      undoBtn.onclick = undoSend;
      toast.appendChild(undoBtn);
    }
    toast.classList.add("show");
    clearTimeout(undoTimeout);
    undoTimeout = setTimeout(()=>{
      toast.classList.remove("show");
      if(pendingSend){ actuallySend(pendingData); pendingSend=false; pendingData=null; }
    },3000);
  }
  function updateToast(message, success=true){
    const toast = document.getElementById("toast");
    toast.innerHTML = message;
    toast.style.background = success ? "#28a745" : "#dc3545";
    toast.classList.add("show");
    clearTimeout(undoTimeout);
    undoTimeout = setTimeout(()=> toast.classList.remove("show"),2000);
  }
  function undoSend(){ pendingSend=false; pendingData=null; updateToast("Du ångrade ditt förslag", false); const button=document.getElementById("send-suggestion"); resetButton(button,0); }

  function actuallySend(data){
    const { suggestion, userAgent, screenSize, button } = data;
    if(mockMode){
      updateToast("Mockläge – mejl skickas ej");
      incrementCount();
      resetButton(button);
    } else {
      emailjs.send("service_ke92itt","template_341abdv",{ suggestion, userAgent, screenSize })
        .then(()=> {
          incrementCount();
          updateToast("Förslaget skickat!");
          document.getElementById("suggestion-input").value = "";
          button.textContent = "Skickat!";
          resetButton(button,3000);
        })
        .catch(err=>{
          console.error(err);
          updateToast("Något gick fel, försök igen", false);
          resetButton(button);
        });
    }
  }
  function resetButton(button, delay=2000){ setTimeout(()=>{ button.disabled=false; button.textContent="Skicka förslag"; }, delay); }

  // ===== Filterfunktion =====
  function filterVideos(category, searchText){
    let results = searchText ? fuse.search(searchText) : videoData.map(v=>({ item:v, matches:[] }));
    let visibleCount = 0;
    videoData.forEach(v=>{
      const cats = v.category.split(' ');
      const matchesCategory = (category === 'Alla' || cats.includes(category));
      const matchResult = results.find(r => r.item === v);
      const show = matchesCategory && !!matchResult;
      v.element.style.display = show ? 'block' : 'none';

      const h2 = v.element.querySelector('h2');
      if(matchResult && matchResult.matches.length>0){
        const titleMatch = matchResult.matches.find(m => m.key === 'title');
        if(titleMatch) h2.innerHTML = highlightText(v.title, titleMatch.indices);
        else h2.textContent = v.title;
      } else h2.textContent = v.title;

      if(show) visibleCount++;
    });

    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
  }

  // ===== Kategori klick =====
  function initCategoryClicks(){
    const links = document.querySelectorAll('.categories a');
    links.forEach(link=>{
      link.addEventListener('click', e=>{
        e.preventDefault();
        const category = link.textContent;
        links.forEach(l=>l.classList.remove('active'));
        link.classList.add('active');
        filterVideos(category, search.value.trim().toLowerCase());
        if(window.innerWidth <= 500) activeLabel.textContent = "Sök i: " + category;
      });
    });
  }

  // ===== Sökfält =====
  search.addEventListener('input', ()=>{
    const value = search.value.trim().toLowerCase();
    const activeCategory = document.querySelector('.categories a.active').textContent;
    if(window.innerWidth<=500){
      categoriesEl.style.display = value ? 'none' : 'flex';
      activeLabel.style.display = value ? 'block' : 'none';
      updateSearchAllBtn();
    }
    filterVideos(activeCategory, value);
    if(value==="lastupdate") document.getElementById("last-updated").style.display="block";
    if(value==="nomail"){ mockMode=true; showToast("Mockläge aktiverat – mejl skickas ej"); }
    if(value==="yesmail"){ mockMode=false; showToast("Riktiga mejl aktiverade igen"); }
  });

  // ===== Sök i alla-knapp =====
  searchAllBtn.addEventListener('click', ()=>{
    const value = search.value.trim().toLowerCase();
    filterVideos("Alla", value);
    activeLabel.textContent = value ? "Sök i: Alla" : "";
    activeLabel.style.display = value ? 'block' : 'none';
    updateSearchAllBtn();
  });
  function updateSearchAllBtn(){
    const categoriesVisible = window.getComputedStyle(categoriesEl).display !== 'none';
    const activeCategory = document.querySelector('.categories a.active').textContent;
    searchAllBtn.style.display = (!categoriesVisible && activeCategory !== "Alla" && search.value.trim()) ? 'inline-block' : 'none';
  }
  window.addEventListener('resize', updateSearchAllBtn);
  updateSearchAllBtn();

  // ===== Förslagsformulär (localStorage-limit) =====
  function canSendToday(){
    const today = new Date().toISOString().split('T')[0];
    let stored = JSON.parse(localStorage.getItem("suggestionLimit")||"{}");
    if(!stored.date || stored.date !== today){ stored = { date: today, count: 0 }; localStorage.setItem("suggestionLimit", JSON.stringify(stored)); return true; }
    return stored.count < MAX_PER_DAY;
  }
  function incrementCount(){
    const today = new Date().toISOString().split('T')[0];
    let stored = JSON.parse(localStorage.getItem("suggestionLimit")||"{}");
    if(!stored.date || stored.date !== today){ stored = { date: today, count: 1 }; } else { stored.count += 1; }
    localStorage.setItem("suggestionLimit", JSON.stringify(stored));
  }
  document.getElementById("send-suggestion").addEventListener('click', ()=>{
    const suggestion = document.getElementById("suggestion-input").value.trim();
    const button = document.getElementById("send-suggestion");
    if(!suggestion){ showToast("Skriv in ditt förslag först", false); return; }
    if(!canSendToday()){ showToast("Max antal förslag för idag uppnått", false); return; }
    const userAgent = navigator.userAgent;
    const screenSize = `${window.screen.width}x${window.screen.height}`;
    button.disabled = true;
    button.textContent = "Skickar...";
    pendingSend = true;
    pendingData = { suggestion, userAgent, screenSize, button };
    showToast("Förslag redo att skickas", true, true);
  });

  </script>
</body>
</html>
